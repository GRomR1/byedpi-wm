<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Debug - ByeDPI Web Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>
        .status-ok { color: #155724; background-color: #d4edda; padding: 2px 6px; border-radius: 3px; }
        .status-error { color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 3px; }
        .status-warning { color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 3px; }
        .debug-section { margin-bottom: 16px; }
        .debug-output { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 8px; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
            max-height: 300px; 
            overflow-y: auto;
        }
        .grid-auto { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="block">
        <h1 class="text-xl font-normal">MikroTik Diagnostic Tool</h1>
        <p class="text-base">Диагностика проблем с ByeDPI на MikroTik</p>
        <div class="grid grid-cols-3">
            <button class="button form-element" onclick="runSystemCheck()">Проверка системы</button>
            <button class="button form-element" onclick="runFullDiagnostic()">Полная диагностика</button>
            <button class="button form-element" onclick="testDirectConnections()">Прямое подключение</button>
        </div>
    </div>

    <div class="block" id="systemInfo" style="display: none;">
        <h2 class="text-lg font-normal border-b">Информация о системе</h2>
        <div id="systemInfoContent" class="debug-output"></div>
    </div>

    <div class="block" id="diagnosticResults" style="display: none;">
        <h2 class="text-lg font-normal border-b">Результаты диагностики</h2>
        
        <div class="debug-section">
            <h3 class="text-base font-normal">DNS Connectivity</h3>
            <div id="dnsResults" class="grid-auto"></div>
        </div>

        <div class="debug-section">
            <h3 class="text-base font-normal">Порты ByeDPI</h3>
            <div id="portResults"></div>
        </div>

        <div class="debug-section">
            <h3 class="text-base font-normal">Тест URL</h3>
            <div id="urlResults"></div>
        </div>
    </div>

    <div class="block" id="customTest">
        <h2 class="text-lg font-normal border-b">Ручная проверка</h2>
        <div class="grid grid-cols-2">
            <div>
                <label class="text-sm">Порт для проверки:</label>
                <input type="number" id="testPort" class="input form-element" value="20001" min="1" max="65535">
                <button class="button form-element" onclick="testSpecificPort()">Проверить порт</button>
            </div>
            <div>
                <label class="text-sm">URL для проверки:</label>
                <input type="text" id="testUrl" class="input form-element" value="https://youtube.com" placeholder="https://example.com">
                <button class="button form-element" onclick="testSpecificUrl()">Проверить URL</button>
            </div>
        </div>
        <div id="customTestResults" class="debug-output" style="display: none;"></div>
    </div>

    <div class="block" id="recommendations" style="display: none;">
        <h2 class="text-lg font-normal border-b">Рекомендации</h2>
        <div id="recommendationsContent"></div>
    </div>

    <div class="block" id="logs">
        <h2 class="text-lg font-normal border-b">Логи</h2>
        <div id="logOutput" class="debug-output">Нажмите кнопку для запуска диагностики...</div>
    </div>
</div>

<script>
let logContainer = document.getElementById('logOutput');

function log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
    logContainer.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
    logContainer.scrollTop = logContainer.scrollHeight;
}

function clearLogs() {
    logContainer.innerHTML = '';
}

async function runSystemCheck() {
    clearLogs();
    log('Запуск проверки системы...');
    
    try {
        const response = await fetch('mikrotik_debug.php');
        const data = await response.json();
        
        if (data.success) {
            displaySystemInfo(data.data);
            log('Информация о системе получена', 'success');
        } else {
            log('Ошибка получения информации о системе: ' + data.error, 'error');
        }
    } catch (error) {
        log('Ошибка: ' + error.message, 'error');
    }
}

async function runFullDiagnostic() {
    clearLogs();
    log('Запуск полной диагностики...');
    
    try {
        const response = await fetch('mikrotik_debug.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'full' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayDiagnosticResults(data.data);
            generateRecommendations(data.data);
            log('Полная диагностика завершена', 'success');
        } else {
            log('Ошибка диагностики: ' + data.error, 'error');
        }
    } catch (error) {
        log('Ошибка: ' + error.message, 'error');
    }
}

async function testDirectConnections() {
    clearLogs();
    log('Тестирование прямых подключений...');
    
    const urls = ['https://youtube.com', 'https://google.com', 'https://example.com'];
    
    for (const url of urls) {
        try {
            const response = await fetch('mikrotik_debug.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'direct_test', url: url })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const result = data.data;
                if (result.success) {
                    log(`${url}: OK (${result.http_code}, ${result.duration_ms}ms)`, 'success');
                } else {
                    log(`${url}: FAIL - ${result.curl_error}`, 'error');
                }
            }
        } catch (error) {
            log(`${url}: ERROR - ${error.message}`, 'error');
        }
    }
}

async function testSpecificPort() {
    const port = document.getElementById('testPort').value;
    if (!port) return;
    
    log(`Тестирование порта ${port}...`);
    
    try {
        const response = await fetch('mikrotik_debug.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'port_test', port: parseInt(port) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayCustomTestResults(data.data);
        } else {
            log('Ошибка тестирования порта: ' + data.error, 'error');
        }
    } catch (error) {
        log('Ошибка: ' + error.message, 'error');
    }
}

async function testSpecificUrl() {
    const url = document.getElementById('testUrl').value;
    if (!url) return;
    
    log(`Тестирование URL ${url}...`);
    
    try {
        const response = await fetch('mikrotik_debug.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'direct_test', url: url })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const result = data.data;
            document.getElementById('customTestResults').style.display = 'block';
            document.getElementById('customTestResults').innerHTML = JSON.stringify(result, null, 2);
            
            if (result.success) {
                log(`${url}: OK (${result.http_code}, ${result.duration_ms}ms)`, 'success');
            } else {
                log(`${url}: FAIL - ${result.curl_error}`, 'error');
            }
        }
    } catch (error) {
        log('Ошибка: ' + error.message, 'error');
    }
}

function displaySystemInfo(info) {
    document.getElementById('systemInfo').style.display = 'block';
    document.getElementById('systemInfoContent').innerHTML = JSON.stringify(info, null, 2);
}

function displayDiagnosticResults(results) {
    document.getElementById('diagnosticResults').style.display = 'block';
    
    // DNS Results
    const dnsContainer = document.getElementById('dnsResults');
    dnsContainer.innerHTML = '';
    results.dns_connectivity.forEach(dns => {
        const div = document.createElement('div');
        div.className = 'block';
        div.innerHTML = `
            <strong>${dns.dns_server}</strong> (${dns.ip})<br>
            <span class="${dns.reachable ? 'status-ok' : 'status-error'}">
                ${dns.reachable ? 'OK' : 'FAIL'} (${dns.duration_ms}ms)
            </span>
            ${dns.error ? `<br><small>${dns.error}</small>` : ''}
        `;
        dnsContainer.appendChild(div);
    });
    
    // Port Results
    const portContainer = document.getElementById('portResults');
    portContainer.innerHTML = '';
    results.port_diagnostics.forEach(portData => {
        const div = document.createElement('div');
        div.className = 'block';
        div.innerHTML = `
            <strong>Порт ${portData.port}</strong><br>
            Процесс: <span class="${portData.process_check.process_found ? 'status-ok' : 'status-error'}">
                ${portData.process_check.process_found ? 'OK' : 'НЕ НАЙДЕН'}
            </span><br>
            Порт слушает: <span class="${portData.port_listening.listening ? 'status-ok' : 'status-error'}">
                ${portData.port_listening.listening ? 'OK' : 'НЕТ'}
            </span><br>
            SOCKS5 тест: <span class="${portData.socks5_test.success ? 'status-ok' : 'status-error'}">
                ${portData.socks5_test.success ? 'OK' : 'FAIL'}
            </span>
            ${!portData.socks5_test.success ? `<br><small>${portData.socks5_test.curl_error}</small>` : ''}
        `;
        portContainer.appendChild(div);
    });
    
    // URL Results
    const urlContainer = document.getElementById('urlResults');
    urlContainer.innerHTML = '';
    results.test_urls.forEach(urlData => {
        const div = document.createElement('div');
        div.className = 'block';
        div.innerHTML = `
            <strong>${urlData.url}</strong><br>
            <span class="${urlData.success ? 'status-ok' : 'status-error'}">
                ${urlData.success ? `OK (${urlData.http_code}, ${urlData.duration_ms}ms)` : `FAIL - ${urlData.curl_error}`}
            </span>
        `;
        urlContainer.appendChild(div);
    });
}

function displayCustomTestResults(result) {
    document.getElementById('customTestResults').style.display = 'block';
    document.getElementById('customTestResults').innerHTML = JSON.stringify(result, null, 2);
}

function generateRecommendations(results) {
    document.getElementById('recommendations').style.display = 'block';
    const container = document.getElementById('recommendationsContent');
    
    let recommendations = [];
    
    // Check DNS connectivity
    const dnsIssues = results.dns_connectivity.filter(dns => !dns.reachable);
    if (dnsIssues.length > 0) {
        recommendations.push('❌ Проблемы с DNS: некоторые DNS серверы недоступны. Проверьте интернет-подключение.');
    }
    
    // Check processes
    const processIssues = results.port_diagnostics.filter(p => !p.process_check.process_found);
    if (processIssues.length > 0) {
        recommendations.push('❌ Процессы ciadpi не запущены на портах: ' + 
            processIssues.map(p => p.port).join(', ') + '. Запустите ByeDPI серверы.');
    }
    
    // Check SOCKS5
    const socksIssues = results.port_diagnostics.filter(p => !p.socks5_test.success);
    if (socksIssues.length > 0) {
        recommendations.push('❌ SOCKS5 прокси не работает на портах: ' + 
            socksIssues.map(p => p.port).join(', ') + '. Возможные причины:');
        recommendations.push('   • Увеличьте таймауты curl (5-10 секунд для connection, 15-30 для max)');
        recommendations.push('   • Проверьте сетевые настройки контейнера');
        recommendations.push('   • Убедитесь что порты пробрасываются корректно');
    }
    
    // Check direct connectivity
    const urlIssues = results.test_urls.filter(url => !url.success);
    if (urlIssues.length > 0) {
        recommendations.push('❌ Прямое подключение не работает к: ' + 
            urlIssues.map(u => u.url).join(', ') + '. Проверьте интернет-подключение.');
    }
    
    if (recommendations.length === 0) {
        recommendations.push('✅ Все проверки пройдены успешно!');
    }
    
    container.innerHTML = recommendations.map(r => `<div class="text-sm" style="margin-bottom: 4px;">${r}</div>`).join('');
}

// Auto-run system check on page load
window.addEventListener('load', () => {
    runSystemCheck();
});
</script>

</body>
</html> 